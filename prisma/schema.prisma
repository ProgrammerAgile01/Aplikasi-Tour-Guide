// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- ENUM ---
enum TripStatus {
  ongoing
  completed
}

// --- MODEL ---
model Trip {
  /// Gunakan String @id agar bisa pakai id kustom (mis. "komodo-2025")
  id          String     @id
  name        String
  status      TripStatus
  description String
  startDate   DateTime
  endDate     DateTime
  location    String
  createdAt   DateTime   @default(now())

  // === RELATION BACK (WAJIB) ===
  schedules   Schedule[] @relation("TripSchedules")
  announcements Announcement[]
  participants Participant[]
  userTrips   UserTrip[]
  feedbacks     Feedback[] 
  whatsappMessages WhatsAppMessage[]

  @@index([status])
  @@index([startDate, endDate])
}

model Schedule {
  id              String   @id @default(cuid())

  // FK â†’ Trip
  tripId          String
  trip            Trip     @relation("TripSchedules", fields: [tripId], references: [id], onDelete: Cascade)

  day             Int
  dateText        String    @db.VarChar(64)   // text tanggal tampilan
  timeText        String    @db.VarChar(16)   // "HH:mm" atau sejenis

  // kategori bebas (input string)
  category        String?   @db.VarChar(120)

  title           String

  // teks lokasi + tautan peta (sekarang OSM)
  location        String    @db.VarChar(255)
  locationMapUrl  String?   @db.VarChar(512)

  // âœ… NEW: koordinat hasil pick di peta (opsional)
  // gunakan Decimal untuk akurasi 7 digit (â‰ˆ1.1 cm)
  locationLat     Decimal?  @db.Decimal(10, 7)
  locationLon     Decimal?  @db.Decimal(10, 7)

  // petunjuk multi (JSON array of string)
  hints           Json?

  description     String?
  isChanged       Boolean   @default(false)
  isAdditional    Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@index([tripId])
  @@index([tripId, day])
  @@index([tripId, day, timeText])          // bantu sorting jadwal harian
  @@index([category])
  @@index([locationLat, locationLon])       // query berdasar radius/koordinat
}

// === Announcements ===
enum AnnouncementPriority {
  NORMAL
  IMPORTANT
}

model Announcement {
  id        String                @id @default(cuid())
  tripId    String
  trip      Trip                  @relation(fields: [tripId], references: [id], onDelete: Cascade)

  title     String
  content   String
  priority  AnnouncementPriority  @default(NORMAL)
  isPinned  Boolean               @default(false)

  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([tripId])
  @@index([priority, isPinned])
}

model Participant {
  id            String   @id @default(cuid())
  name          String
  whatsapp      String
  address       String
  lastCheckIn   String? // simpan string agar cocok dengan UI (mis. "Pulau Komodo - 10:15")
  totalCheckIns Int      @default(0)
  tripId        String
  trip          Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())

  loginEmail        String?   @db.VarChar(191)
  initialPassword   String?   @db.VarChar(191) // simpan "raw" one-time password
  initialPasswordAt DateTime? // kapan password awal dibuat

  feedbacks         Feedback[]
  whatsappMessages WhatsAppMessage[]

  @@index([tripId])
  @@index([whatsapp])
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String
  name       String
  whatsapp   String   @unique
  role       String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  userTrips  UserTrip[]

  @@index([role])
}


model UserTrip {
  id         String   @id @default(cuid())
  userId     String
  tripId     String
  roleOnTrip String?   // optional, e.g. "PESERTA", "GUIDE"
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([userId, tripId])
  @@index([userId])
  @@index([tripId])
}

enum CheckinMethod {
  GEO
  QR
  ADMIN
}

model Attendance {
  id             String        @id @default(cuid())
  tripId         String
  sessionId      String        // Schedule.id
  participantId  String        // Participant.id
  method         CheckinMethod
  checkedAt      DateTime      @default(now())

  @@unique([participantId, sessionId]) // cegah double checkin untuk sesi yang sama
  @@index([tripId, sessionId])
}

model Feedback {
  id            String       @id @default(cuid())
  tripId        String
  participantId String?   // ðŸ‘ˆ boleh null

  rating        Int
  notes         String?
  createdAt     DateTime     @default(now())

  trip        Trip         @relation(fields: [tripId], references: [id], onDelete: Cascade)
  participant Participant? @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([participantId])
  @@unique([tripId, participantId])  // boleh, NULL di MySQL tidak bentrok
}

enum WhatsAppStatus {
  PENDING   // baru diantrikan
  SENDING   // sedang diproses worker
  SUCCESS   // sukses kirim ke wa-service
  FAILED    // gagal (error, limit, dsb)
}

model WhatsAppMessage {
  id            String          @id @default(cuid())

  tripId        String?
  participantId String?

  to            String          @db.VarChar(32)   // nomor WA (62xxxxx)
  template      String?         @db.VarChar(100)  // mis: "TRIP_SCHEDULE_FULL"
  content       String          @db.MediumText    // isi pesan WA
  payload       Json?                                  // data tambahan (tripId, dll)

  status        WhatsAppStatus  @default(PENDING)
  error         String?         @db.VarChar(512)
  sentAt        DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  trip          Trip?           @relation(fields: [tripId], references: [id])
  participant   Participant?    @relation(fields: [participantId], references: [id])

  @@index([tripId])
  @@index([participantId])
  @@index([status, createdAt])
}