// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- ENUM ---
enum TripStatus {
  ongoing
  completed
}

// --- MODEL ---
model Trip {
  /// Gunakan String @id agar bisa pakai id kustom (mis. "komodo-2025")
  id          String     @id
  name        String
  status      TripStatus
  description String
  startDate   DateTime
  endDate     DateTime
  location    String
  createdAt   DateTime   @default(now())
  deletedAt   DateTime?

  // === RELATION BACK (WAJIB) ===
  schedules   Schedule[] @relation("TripSchedules")
  announcements Announcement[]
  participants Participant[]
  userTrips   UserTrip[]
  feedbacks     Feedback[] 
  whatsappMessages WhatsAppMessage[]
  attendances      Attendance[]
  galleries        Gallery[]
  badgeDefinitions BadgeDefinition[]
  participantBadges ParticipantBadge[]
  whatsappTemplates WhatsAppTemplate[]
  flights          Flight[]

  @@index([status])
  @@index([startDate, endDate])
}

model Schedule {
  id              String   @id @default(cuid())

  // FK → Trip
  tripId          String
  trip            Trip     @relation("TripSchedules", fields: [tripId], references: [id], onDelete: Cascade)

  day             Int
  dateText        String    @db.VarChar(64)   // text tanggal tampilan
  timeText        String    @db.VarChar(16)   // "HH:mm" atau sejenis

  // kategori bebas (input string)
  category        String?   @db.VarChar(120)

  title           String

  // teks lokasi + tautan peta (sekarang OSM)
  location        String    @db.VarChar(255)
  locationMapUrl  String?   @db.VarChar(512)

  // koordinat hasil pick di peta (opsional)
  // gunakan Decimal untuk akurasi 7 digit (≈1.1 cm)
  locationLat     Decimal?  @db.Decimal(10, 7)
  locationLon     Decimal?  @db.Decimal(10, 7)

  // petunjuk multi (JSON array of string)
  hints           Json?

  description     String?
  isChanged       Boolean   @default(false)
  isAdditional    Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt
  deletedAt       DateTime?

  attendances      Attendance[]
  galleries        Gallery[]
  badgeDefinitions BadgeDefinition[]
  feedbacks        Feedback[]

  @@index([tripId])
  @@index([tripId, day])
  @@index([tripId, day, timeText])          // bantu sorting jadwal harian
  @@index([category])
  @@index([locationLat, locationLon])       // query berdasar radius/koordinat
}

// === Announcements ===
enum AnnouncementPriority {
  NORMAL
  IMPORTANT
}

model Announcement {
  id        String                @id @default(cuid())
  tripId    String
  trip      Trip                  @relation(fields: [tripId], references: [id], onDelete: Cascade)

  title     String
  content   String
  priority  AnnouncementPriority  @default(NORMAL)
  isPinned  Boolean               @default(false)

  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  deletedAt DateTime?

  @@index([tripId])
  @@index([priority, isPinned])
}

enum ParticipantGender {
  MALE   // Laki-laki
  FEMALE // Perempuan
}

model Participant {
  id            String   @id @default(cuid())
  name          String
  whatsapp      String
  address       String
  note          String?  @db.Text
  
  nik           String?  @db.VarChar(32)
  birthPlace    String?  @db.VarChar(191)
  birthDate     DateTime?
  gender        ParticipantGender?
  roomNumber    String?  @db.VarChar(32)

  lastCheckIn   String? // simpan string agar cocok dengan UI (mis. "Pulau Komodo - 10:15")
  totalCheckIns Int      @default(0)
  tripId        String
  trip          Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())

  loginUsername String?   @db.VarChar(191)
  initialPassword String?   @db.VarChar(191)
  deletedAt     DateTime?

  feedbacks         Feedback[]
  whatsappMessages WhatsAppMessage[]
  attendances      Attendance[]
  userTrips         UserTrip[]
  galleries         Gallery[]
  participantBadges ParticipantBadge[]
  flights          Flight[]

  @@index([tripId])
  @@index([whatsapp])
}

model User {
  id         String   @id @default(cuid())
  username   String   @unique
  password   String
  name       String
  whatsapp   String
  role       String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  deletedAt  DateTime?

  userTrips  UserTrip[]

  @@index([role])
}


model UserTrip {
  id         String   @id @default(cuid())
  userId     String
  tripId     String
  participantId String?
  roleOnTrip String?   // optional, e.g. "PESERTA", "GUIDE"
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  participant Participant? @relation(fields: [participantId], references: [id], onDelete: SetNull)

  @@unique([userId, tripId])
  @@index([userId])
  @@index([tripId])
  @@index([participantId])
}

enum CheckinMethod {
  GEO
  QR
  ADMIN
}

model Attendance {
  id             String        @id @default(cuid())
  tripId         String
  sessionId      String        // Schedule.id
  participantId  String        // Participant.id
  method         CheckinMethod
  checkedAt      DateTime      @default(now())

  trip         Trip        @relation(fields: [tripId],        references: [id], onDelete: Cascade)
  session      Schedule    @relation(fields: [sessionId],     references: [id], onDelete: Cascade)
  participant  Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, sessionId]) // cegah double checkin untuk sesi yang sama
  @@index([tripId, sessionId])
}

model Feedback {
  id            String       @id @default(cuid())
  tripId        String
  participantId String?   // boleh null
  sessionId     String

  rating        Int
  notes         String?
  createdAt     DateTime     @default(now())
  deletedAt     DateTime?

  trip        Trip         @relation(fields: [tripId], references: [id], onDelete: Cascade)
  participant Participant? @relation(fields: [participantId], references: [id], onDelete: Cascade)
  session     Schedule     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([participantId])
  @@index([tripId, sessionId])
  @@unique([tripId, participantId, sessionId])  // 1 peserta 1 ulasan per sesi
}

enum WhatsAppStatus {
  PENDING   // baru diantrikan
  SENDING   // sedang diproses worker
  SUCCESS   // sukses kirim ke wa-service
  FAILED    // gagal (error, limit, dsb)
}

model WhatsAppMessage {
  id            String          @id @default(cuid())

  tripId        String?
  participantId String?

  to            String          @db.VarChar(32)   // nomor WA (62xxxxx)
  template      String?         @db.VarChar(100)  // mis: "TRIP_SCHEDULE_FULL"
  content       String          @db.MediumText    // isi pesan WA
  payload       Json?                                  // data tambahan (tripId, dll)

  status        WhatsAppStatus  @default(PENDING)
  error         String?         @db.VarChar(512)
  sentAt        DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  trip          Trip?           @relation(fields: [tripId], references: [id])
  participant   Participant?    @relation(fields: [participantId], references: [id])

  @@index([tripId])
  @@index([participantId])
  @@index([status, createdAt])
}

model Setting {
  id          String   @id       // kita pakai "GLOBAL" sebagai id tetap
  logoUrl     String?  @db.VarChar(512)
  tripName    String?  @db.VarChar(191)
  description String?  @db.Text

  geoReminderRadiusMeters   Int? @default(1000)
  geoAttendanceRadiusMeters Int? @default(200)
  attendanceGraceMinutes Int? @default(15)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum GalleryStatus {
  PENDING
  APPROVED
}

model Gallery {
  id            String   @id @default(cuid())

  tripId        String
  trip          Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)

  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  sessionId     String
  session       Schedule    @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  note          String?
  imageUrl      String   @db.VarChar(512)

  status        GalleryStatus @default(PENDING)  // status: PENDING / APPROVED

  createdAt     DateTime @default(now())
  deletedAt     DateTime?

  @@index([tripId])
  @@index([participantId])
  @@index([sessionId])
  @@index([status])
}

enum BadgeConditionType {
  CHECKIN_SESSION        // check-in di sesi tertentu
  GALLERY_UPLOAD_SESSION // upload X foto di sesi tertentu
  COMPLETE_ALL_SESSIONS  // hadir di semua sesi trip
}

model BadgeDefinition {
  id          String              @id @default(cuid())
  tripId      String
  trip        Trip                @relation(fields: [tripId], references: [id], onDelete: Cascade)

  code        String              @db.VarChar(64) // mis. "LABUAN_BAJO_EXPLORER"
  name        String
  description String
  icon        String              @db.VarChar(32) // "ship", "mountain", dst.
  location    String?             @db.VarChar(191)

  conditionType BadgeConditionType
  targetValue   Int?              // mis. 3 untuk "upload 3 foto"
  sessionId     String?
  session       Schedule?         @relation(fields: [sessionId], references: [id])

  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  deletedAt   DateTime?

  participantBadges ParticipantBadge[]

  @@index([tripId])
  @@index([code])
}

model ParticipantBadge {
  id            String          @id @default(cuid())
  tripId        String
  participantId String
  badgeId       String
  unlockedAt    DateTime        @default(now())

  trip        Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  participant Participant    @relation(fields: [participantId], references: [id], onDelete: Cascade)
  badge       BadgeDefinition @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([participantId, badgeId]) // 1 badge cuma sekali per peserta
  @@index([tripId, participantId])
}

enum WhatsAppTemplateType {
  SCHEDULE                   // kirim jadwal lengkap
  PARTICIPANT_REGISTERED_NEW // peserta didaftarkan (akun baru dibuat)
  PARTICIPANT_REGISTERED_EXISTING // peserta ditambahkan ke trip (akun sudah ada)
  ANNOUNCEMENT               // pengumuman trip
}

model WhatsAppTemplate {
  id        String               @id @default(cuid())

  tripId    String
  trip      Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)

  type      WhatsAppTemplateType
  name      String               @db.VarChar(100) // label di UI
  content   String               @db.Text         // isi template dengan {{placeholder}}

  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@unique([tripId, type])
  @@index([tripId])
  @@index([type])
}

enum FlightDirection {
  DEPARTURE  // berangkat
  RETURN     // pulang
}

enum FlightPassengerRole {
  PESERTA
  TL_AGENT
}

model Flight {
  id          String   @id @default(cuid())

  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  // Optional: link ke Participant kalau ini penerbangan milik peserta
  participantId String?
  participant   Participant? @relation(fields: [participantId], references: [id], onDelete: SetNull)

  // Data utama
  passengerName   String                 // nama (peserta atau TL agent)
  role            FlightPassengerRole    // PESERTA / TL_AGENT

  orderId         String?   @db.VarChar(100)  // id pesanan (boleh kosong kalau manual)
  flightNumber1   String    @db.VarChar(50)   // pesawat 1
  flightNumber2   String?   @db.VarChar(50)   // pesawat 2 (opsional)

  airline1        String    @db.VarChar(100)  // maskapai 1
  airline2        String?   @db.VarChar(100)  // maskapai 2 (opsional)

  ticketNumber    String    @db.VarChar(100)  // nomor tiket

  direction       FlightDirection          // berangkat / pulang

  notes           String?   @db.Text       // kalau mau catatan tambahan (opsional)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  @@index([tripId])
  @@index([participantId])
  @@index([direction])
  @@index([role])
}